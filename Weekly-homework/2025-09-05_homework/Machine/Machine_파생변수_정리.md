
---

# 📦 파생 변수(Feature Engineering) 정리

## 0) 한 줄 정의

**파생 변수** = 기존 변수의 정보를 **변환·결합·집계**해 모델이 배우기 쉬운 **새로운 특징**을 만드는 작업.

---

## 1) 왜 하는가? (효과)

* **성능**: 모델이 관계를 더 쉽게 학습 → **과적합 완화**·일반화 향상.
* **해석**: **도메인 기반** 변수는 사람 눈에도 의미가 분명.
* **메모리/속도**: 정보 압축으로 **전처리·추론 속도** 개선.
* **안정성**: 스케일/분포를 정리하면 **최적화가 안정적**(특히 선형/신경망).

> 트리 계열(XGBoost/LightGBM/랜덤포레스트)은 스케일에 덜 민감하지만, **로그/비율/상호작용/집계**는 여전히 효과적.

---

## 2) 큰 분류 (What)

1. **변수 자체 변환**: 함수 변환(로그/제곱근/박스콕스/여-존슨), 스케일링, 구간화
2. **변수 간 상호작용/합성**: 합/차/곱/비율, 다항식/교차항
3. **집계·통계 기반**: 그룹별 평균/표준편차/순위/백분위(quantile) 등
4. **시간/날짜**: 시점 분해(연·월·주·요일·시간), **시차(lag)**, **이동(rolling)**, 이벤트/연휴 플래그
5. **범주형 인코딩**: One-Hot, 빈도/순위, **타깃 인코딩(누수 주의)**, CatBoost/LOO 방식
6. **텍스트/좌표 등 도메인별**: 길이/단어 수, TF-IDF, 위경도→거리/클러스터, 이미지/신호 분해
7. **이상치/클리핑/윈저화**: 극단값의 영향 제어
8. **차원 축소·선택(보너스)**: PCA/SVD/NMF, MI/ANOVA/Permutation Importance

---

## 3) 변수 자체 변환 (함수 변환·스케일링·구간화)

### 3.1 함수 변환

* **로그 변환**: 오른쪽 꼬리 긴 양의 값(가격, 면적, 거래량 등)

  * `np.log(x)` → 0/음수 **불가**
  * `np.log1p(x)` → **0 포함 가능**(x≥0), 결과는 log(1+x)
* **제곱근 변환**: 분산이 큰 양의 값, 로그보다 완만
* **Box-Cox**: **양수만** 가능, λ로 최적 변환(로그/제곱근/거듭제곱 일반화)
* **Yeo-Johnson**: **음수/0 허용**, 실무에서 박스콕스 대체로 자주 사용

> 로그했더니 분포가 더 치우치면 **Box-Cox/Yeo-Johnson** 검토.

### 3.2 스케일링(연속형 스케일 통일)

| 방법           | 특징/언제                                          |
| ------------ | ---------------------------------------------- |
| **MinMax**   | \[0,1]로 압축. \*\*신경망/거리기반(KNN)\*\*에 유리. 이상치에 약함 |
| **Standard** | 평균 0, 표준편차 1. **선형/로지스틱/NN** 기본 선택             |
| **Robust**   | 중앙값/IQR 기반. **이상치 많은 경우**                      |
| **MaxAbs**   | \[-1,1] 범위. 희소 벡터 유지에 적합                       |
| **L2 정규화**   | 행 단위 길이 1. 코사인 유사도/텍스트 피처                      |

### 3.3 구간화(Binning)

* **연속 → 범주**: 등간격, **등빈도(quantile)**, 도메인 기준(예: 새벽/아침/점심…)
* **효과**: 비선형 경계, 이상치 둔감, 해석 용이(단 과도한 구간화는 정보 손실)

---

## 4) 시간 변수(핵심)

* **시점 분해**: 연·월·일·주차(ISO)·요일(0~~6)·시간(0~~23)·분기(1\~4)·공휴일/주말 플래그
* **시간 차**: 기준일과의 **경과일수/개월수/연수**(예: `경과연수 = (관측일 - 사용승인일)/365`)
* **Lag/Lead**: 과거값/미래값(예측 시 미래 참조 금지!)
* **Rolling**: 최근 k기간 평균/합/최대/표준편차
* **이벤트 캘린더**: 명절/연휴/프로모션/급등락일 플래그

> **시계열/분류 모두** 유용. \*\*시점 보존 분할(TimeSeriesSplit)\*\*로 **누수 방지**.

---

## 5) 변수 간 상호작용

* **산술**: 합, **차**, **비율**, 곱

  * 예) `주차대수÷전체세대수`(가구당 주차여유), `연면적÷대지면적`(용적률), `층/전체동수`
* **다항·교차항**: `x1*x2`, `x1^2`, `x1*x2^2` 등(선형계열에 특히 도움)
* **도메인 파생**: **멤버십 등급 = 월 이용금액 규칙 매핑**, **시설 유무 플래그(수영장/차고/지하)**

> 상호작용은 **문제 가설**을 담아야 의미가 생긴다. 무차별 다항식은 과적합 위험↑.

---

## 6) 집계·통계 기반 파생

* **GroupBy 집계**: 평균/중앙/최대/최소/표준편차/합/개수/고유개수(nunique)
* **상대적 위치**: **z-score, 백분위**, 그룹 내 **순위(rank)**
* **타깃 그룹 통계**(주의): 구/동/단지 등 범주별 **target 평균**(타깃 인코딩과 유사, 반드시 **CV 내 계산**)

> 예) `구별_중위가격`, `단지별_거래수`, `아파트_연식_백분위`.

---

## 7) 범주형 인코딩

| 방식                | 설명/장점           | 주의             |                                           |
| ----------------- | --------------- | -------------- | ----------------------------------------- |
| **One-Hot**       | 해석 쉬움, 트리/선형 OK | 고카디널리티 폭발      |                                           |
| **빈도/순위 인코딩**     | 등장 횟수/순위로 치환    | 의미 왜곡 가능       |                                           |
| **타깃 인코딩**        | 범주→\`E\[y       | cat]\`         | **데이터 누수** 위험 → **KFold 평균**, 스무딩, 노이즈 필요 |
| **Leave-One-Out** | 자기 샘플 제외 평균     | 소규모 데이터 과적합 주의 |                                           |
| **CatBoost 인코딩**  | 누수 완화 구현        | 구현 복잡도         |                                           |

* **희소/희귀 카테고리 병합**: 최소 빈도 이하 `"OTHER"`로 묶기.

---

## 8) 이상치·클리핑

* **winsorize/clip**: 상하위 quantile(예: 1%/99%)로 잘라 영향 완화
* **로그/루트 변환**: 스케일 안정화
* **RobustScaler**: 이상치 민감도 낮춤

---

## 9) 좌표·공간·기타 도메인 팁

* **좌표(위/경도)**: 중심지까지 **거리**, **최근접 POI 거리/개수**, **군집 라벨(KMeans)**
* **텍스트**: 길이/단어수/문장수/특수문자 비율, **TF-IDF**, 토픽(NMF/LDA)
* **이미지/신호**: SVD/NMF/색 히스토그램/주파수 대역 에너지

---

## 10) 누수(Leakage) 방지 원칙 ✅

1. **타깃 의존 변수**(타깃 인코딩/그룹 타깃 통계)는 **훈련 fold 내부에서만** 계산.
2. **시간 변수**는 **미래 정보** 참조 금지(lag는 OK, lead 금지).
3. **스케일러/변환**은 **fit(train)** → **transform(val/test)**.
4. **파이프라인**으로 일괄 관리(Sklearn `Pipeline`, `ColumnTransformer` 권장).

---

## 11) 모델별 민감도 요약

* **선형/로지스틱/신경망/KNN/SVM**: **스케일링 필수**, 로그/여-존슨 효과 큼.
* **트리/부스팅**: 스케일 덜 민감. **비율·로그·집계·상호작용**이 이득.
* **추천/거리기반**: **정규화(L2)**, \*\*차원 축소(SVD/NMF)\*\*가 핵심.

---

## 12) 실전 레시피(예: 아파트 데이터)

* **로그/루트**: `가격_log`, `전용면적_log`, `주차대수_log`
* **연식/경과**: `건물연식 = 기준일 - 사용승인일(연)`, `준공후개월`
* **비율/밀도**: `가구당주차 = 주차대수/전체세대수`, `층당세대수 = 전체세대수/전체동수`
* **입지 요약(집계)**: `구별_중위가격`, `동별_거래수`, `단지군_평균연식`
* **범주 인코딩**: `난방방식`, `관리방식`, `복도유형`→ One-Hot/빈도/타깃 인코딩(CV)
* **시간 요소**: `계약연`, `계약월`, `분기`, `주말거래`, `명절주간`
* **희귀 병합**: 드문 `아파트명`/`동`은 `"기타"`로 묶기

---

## 13) 언제 무엇을 쓸까 (요약 표)

| 문제 상황       | 추천 조치                            |
| ----------- | -------------------------------- |
| 강한 우측 꼬리    | `log1p` → Box-Cox/Yeo-Johnson 비교 |
| 이상치 다수      | `RobustScaler` + 구간화/클리핑         |
| 카디널리티 큼(범주) | 빈도/타깃 인코딩(+CV/스무딩)               |
| 시간 패턴 존재    | lag/rolling/요일/이벤트 플래그           |
| 해석 필요       | 도메인 비율/규칙 기반 파생, 구간화             |
| 데이터 적음      | 단순·의미 있는 소수 파생 + 규제 강화           |

---

## 14) 스니펫(참고용)

```python
# 1) 안전한 로그 변환
df["price_log"] = np.log1p(df["price"].clip(lower=0))

# 2) 박스콕스/여-존슨
from sklearn.preprocessing import PowerTransformer
pt_bc  = PowerTransformer(method="box-cox")   # x > 0
pt_yj  = PowerTransformer(method="yeo-johnson")
df[["x_bc"]] = pt_bc.fit_transform(df[["x"]])
df[["x_yj"]] = pt_yj.fit_transform(df[["x2"]])

# 3) 스케일링 + 파이프라인
from sklearn.compose import ColumnTransformer
from sklearn.preprocessing import OneHotEncoder, StandardScaler, RobustScaler
from sklearn.pipeline import Pipeline
num1 = ["price","area"]
num2 = ["parking_per_household"]  # 이상치 민감
cat  = ["heating","hallway","mgmt"]

ct = ColumnTransformer([
    ("num_std", StandardScaler(), num1),
    ("num_rob", RobustScaler(),   num2),
    ("cat_oh",  OneHotEncoder(handle_unknown="ignore"), cat),
])

pipe = Pipeline([("prep", ct), ("model", GradientBoostingRegressor())])
pipe.fit(X_train, y_train)
```

---

## 15) 체크리스트 ✅

* [ ] 변환/스케일/인코딩은 **훈련 데이터로만 fit**했는가?
* [ ] 시간·타깃 관련 변수에 **누수** 없나?
* [ ] 상호작용·비율이 **도메인 가설**을 담고 있나?
* [ ] 과도한 구간화/원-핫으로 **차원 폭발**하지 않나?
* [ ] **Permutation/SHAP**으로 파생 변수 기여도 검증했나?

---

